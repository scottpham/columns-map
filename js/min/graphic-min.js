function draw_graphic(){if(Modernizr.svg){$("#map").empty();var t=$("#map").width();render(t)}}function render(t){function e(t,e){var o=u.latLngToLayerPoint(new L.LatLng(e,t));this.stream.point(o.x,o.y)}function o(){bounds=g.bounds(y);var t=bounds[0],e=bounds[1];f.attr("width",e[0]-t[0]).attr("height",e[1]-t[1]).style("left",t[0]+"px").style("top",t[1]+"px"),h.attr("transform","translate("+-t[0]+","+-t[1]+")"),$("#faults").is(":checked")&&(d3.selectAll(".faults").remove(),r()),s()}function r(){var t=h.selectAll("path").data(y.features).enter().append("path").attr("class","faults");t.attr("d",g).style("fill","none").transition().delay(w).duration(300).style("stroke","darkred").style("stroke-width",2),t.on("click",l).on("mouseover",function(t,e){$(".info").empty(),$(".info").append("<div class='fault-info'><h4><strong>Fault Name: </strong></h4><p>"+t.properties.name+"</p></div>"),d3.select(this).style("stroke-width",10).style("stroke",colors.yellow3)}).on("mouseout",function(t,e){$(".info").empty().append("<h4>Hover over a Fault Line</h4>"),d3.select(this).style("stroke-width",2).style("stroke","darkred")})}function n(){var t=h.selectAll(".local").data(local.features);t.enter().append("circle").attr("class","local").on("mouseover",function(t,e){k.show(t),d3.select(this).each(D)}).on("mouseout",function(t,e){k.hide(t),d3.select(this).each(E)}).on("click",l),t.transition().delay(C).duration(0).attr("r",8).style("fill",B).style("opacity",.8).style("stroke","black").style("stroke-width",.3)}function a(){var t=h.selectAll(".bart").data(bart.features);t.enter().append("circle").attr("class","bart").on("click",l).on("mouseover",function(t,e){d3.select(this).each(D),A.show(t)}).on("mouseout",function(t,e){d3.select(this).each(E),A.hide(t)}),t.transition().delay(w).duration(0).attr("r",8).style("fill",function(t){return"yes"===t.properties.completed?F:B}).style("opacity",.8).style("stroke","black").style("stroke-width",.3)}function l(t){console.log(t.properties)}function s(){h.selectAll(".local").attr("transform",function(t){return"translate("+u.latLngToLayerPoint(t.LatLng).x+","+u.latLngToLayerPoint(t.LatLng).y+")"}),h.selectAll(".bart").attr("transform",function(t){return"translate("+u.latLngToLayerPoint(t.LatLng).x+","+u.latLngToLayerPoint(t.LatLng).y+")"})}function i(t){475>t&&$("#btn-group").attr("class","btn-group-vertical")}function c(t){$("input[type=checkbox]").each(function(){var t=$(this).attr("id");$(this).is(":checked")&&(d3.selectAll("."+t).remove(),$(this).prop("checked",!1),$(this).parent().removeClass("active"))}),$(t).prop("checked",!0),$(t).parent().addClass("active")}function p(){$(".info").empty();var t=d3.select(".info").append("svg").attr("id","legend").attr("width",150).attr("height",85);t.append("g").attr("class","circleKey").selectAll("g").data([{color:B,text:"Incomplete"},{color:F,text:"Complete"}]).enter().append("g").attr("class","colorsGroup").attr("transform","translate(20, 20)");var e=15;t.selectAll(".colorsGroup").append("circle").style("stroke-width",2).style("fill",function(t){return t.color}).style("stroke","black").attr("r",e).attr("cy",function(t,o){return o*e*3}),t.selectAll(".colorsGroup").append("text").style("font-size",15).attr("x",1.5*e).attr("y",function(t,o){return 3*e*o+5}).text(function(t){return t.text})}function d(){$(".info").empty().append("<h4>Hover over a Fault Line</h4>").css("min-height","50px")}var u=new L.Map("map",{center:[37.74,-122.31],zoom:10,scrollWheelZoom:!1}).addLayer(new L.TileLayer("http://api.tiles.mapbox.com/v4/nbclocal.8621e715/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibmJjbG9jYWwiLCJhIjoiS3RIUzNQOCJ9.le_LAljPneLpb7tBcYbQXQ",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.'})),f=d3.select(u.getPanes().overlayPane).append("svg"),h=f.append("g").attr("class","leaflet-zoom-hide"),y=topojson.feature(faults,faults.objects.faults),m=d3.geo.transform({point:e}),g=d3.geo.path().projection(m);u.on("viewreset",o),o();var b=d3.select("#map").append("div").attr("class","tooltip").style("opacity",0),v=function(t){return t?d3.format("%")(t):"0%"},k=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){return"Locally owned bridge</br>"+v(t.properties.current_construction_phase_complete)+" complete.</br>"+t.properties.description+"</br>Completion Date: "+(t.properties.end_construction?t.properties.end_construction:"Not Available.")}),A=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){return"BART owned Pier</br>"+("yes"==t.properties.completed?"Complete</br>":"Incomplete</br>")+"City: "+t.properties.city+".</br>"+(t.properties.name?t.properties.name+"</br>":"")+("A"==t.properties.line?"Fremont Bound Trains":"R"==t.properties.line?"Richmond Bound Trains":"M"==t.properties.line?"Milbrae Bound Trains":"C"==t.properties.line?"Pitsburg/Bay Point Bound Trains":"")});h.call(k),h.call(A);var w=function(t,e){return.4*e},C=function(t,e){return 25*e};local.features.forEach(function(t){t.LatLng=new L.LatLng(t.geometry.coordinates[1],t.geometry.coordinates[0])}),bart.features.forEach(function(t){t.LatLng=new L.LatLng(t.geometry.coordinates[1],t.geometry.coordinates[0])});var F=colors.blue1,B=colors.orange2,D=function(){this.parentNode.appendChild(this),d3.select(this).attr("r",15).style("opacity",1).style("stroke-width",1.5)},E=function(){var t=this.parentNode.firstChild;t&&this.parentNode.insertBefore(this,t),d3.select(this).attr("r",8).style("opacity",.8).style("stroke-width",.5)};a(),s(),i(t),d3.select("#bart").on("click",function(){console.log($("#bart").is(":checked")),p(),$("#bart").is(":checked")?(c("#bart"),a(),s()):(console.log("else fired"),d3.selectAll(".bart").remove())}),d3.select("#local").on("click",function(){console.log($("#local").is(":checked")),p(),$("#local").is(":checked")?(c("#local"),n(),s()):d3.selectAll(".local").remove()}),d3.select("#faults").on("click",function(){console.log($("#faults").is(":checked")),d(),$("#faults").is(":checked")?(c("#faults"),o()):d3.selectAll("path").style("opacity",0)});var x=L.control({position:"topright"});x.onAdd=function(t){return this._div=L.DomUtil.create("div","info"),this._div},x.addTo(u),p()}var circleSize=70,colors={red1:"#6C2315",red2:"#A23520",red3:"#D8472B",red4:"#E27560",red5:"#ECA395",red6:"#F5D1CA",orange1:"#714616",orange2:"#AA6A21",orange3:"#E38D2C",orange4:"#EAAA61",orange5:"#F1C696",orange6:"#F8E2CA",yellow1:"#77631B",yellow2:"#B39429",yellow3:"#EFC637",yellow4:"#F3D469",yellow5:"#F7E39B",yellow6:"#FBF1CD",teal1:"#0B403F",teal2:"#11605E",teal3:"#17807E",teal4:"#51A09E",teal5:"#8BC0BF",teal6:"#C5DFDF",blue1:"#28556F",blue2:"#3D7FA6",blue3:"#51AADE",blue4:"#7DBFE6",blue5:"#A8D5EF",blue6:"#D3EAF7"};$(window).load(function(){draw_graphic()});